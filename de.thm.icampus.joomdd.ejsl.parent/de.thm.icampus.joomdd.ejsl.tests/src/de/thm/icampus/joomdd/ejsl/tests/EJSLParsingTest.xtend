/*
 * generated by iCampus (JooMDD team) 2.9.1
 */
package de.thm.icampus.joomdd.ejsl.tests

import Util.TemplateLoader
import com.google.common.base.Joiner
import com.google.inject.Inject
import de.thm.icampus.joomdd.ejsl.eJSL.BackendSection
import de.thm.icampus.joomdd.ejsl.eJSL.CMSExtension
import de.thm.icampus.joomdd.ejsl.eJSL.Component
import de.thm.icampus.joomdd.ejsl.eJSL.ContextLink
import de.thm.icampus.joomdd.ejsl.eJSL.DetailsPage
import de.thm.icampus.joomdd.ejsl.eJSL.DynamicPage
import de.thm.icampus.joomdd.ejsl.eJSL.EJSLModel
import de.thm.icampus.joomdd.ejsl.eJSL.Extension
import de.thm.icampus.joomdd.ejsl.eJSL.FrontendSection
import de.thm.icampus.joomdd.ejsl.eJSL.IndexPage
import de.thm.icampus.joomdd.ejsl.eJSL.InternalLink
import de.thm.icampus.joomdd.ejsl.eJSL.Link
import static org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.Test
import org.eclipse.xtext.testing.extensions.InjectionExtension
import org.junit.jupiter.api.^extension.ExtendWith
import org.eclipse.xtext.testing.InjectWith
import org.eclipse.xtext.testing.util.ParseHelper

@ExtendWith(InjectionExtension)
@InjectWith(EJSLInjectorProvider)
class EJSLParsingTest{
	
	//import reference model instances (All tests are based on this model) TODO make dynamic
	public val models = TemplateLoader.getTemplateFiles()
	public String reference = 	TemplateLoader.getOneTemplateFile("Shop")
	
	
	@Inject
	ParseHelper<EJSLModel> parseHelper;
	
	/**
	 * Tests if models can be parsed without errors
	 */
	@Test
	def void ejslModelParsingTest() {
		for (model : models) {
			assertNotNull(parseHelper.parse(model).name)
		}
	}
	
	/**
	 * test the eJSL Entity with attributes and their types
	 */
	@Test
	def void createEntityAttributes() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//lists for entity values
		val attributes = newArrayList()
		val types = newArrayList()
		val unique = newArrayList()
		val primary = newArrayList()
		
		//get values from instance
		for (i : 0 ..< instance.ejslPart.feature.entities.get(0).attributes.size){
			attributes.add(instance.ejslPart.feature.entities.get(0).attributes.get(i).name)
			types.add(instance.ejslPart.feature.entities.get(0).attributes.get(i).type)
			assertNotNull(instance.ejslPart.feature.entities.get(0).attributes.get(i).type, "Error, Type should not be Null")
			unique.add(instance.ejslPart.feature.entities.get(0).attributes.get(i).isIsunique)
			primary.add(instance.ejslPart.feature.entities.get(0).attributes.get(i).isIsprimary)
		}
		
		//join them into a comma separated string
		val actualAttr = Joiner.on(", ").join(attributes)
		val actualType = Joiner.on(", ").join(types)
		val actualUniq = Joiner.on(", ").join(unique)
		val actualPri = Joiner.on(", ").join(primary)
	
		//test attribute names
		assertEquals("name, adress, iBan, bic", actualAttr);
		//test attribute is unique
		assertEquals("true, false, false, false", actualUniq);
		//test attribute is primary
		assertEquals("false, false, false, false", actualPri);
		//test attribute types
		/**assertEquals(
			"de.thm.icampus.joomdd.ejsl.eJSL.impl.StandardTypesImpl@487db668 (type: Short_Text, notnull: false, default: null, autoincrement: false), de.thm.icampus.joomdd.ejsl.eJSL.impl.StandardTypesImpl@46944ca9 (type: Short_Text, notnull: false, default: null, autoincrement: false), de.thm.icampus.joomdd.ejsl.eJSL.impl.StandardTypesImpl@22bac7bc (type: Text, notnull: false, default: null, autoincrement: false), de.thm.icampus.joomdd.ejsl.eJSL.impl.StandardTypesImpl@63798ca7 (type: Text, notnull: false, default: null, autoincrement: false)",
			actualType
		);**/
	}
	
	@Test
	def void partExists() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		assertNotNull(instance.ejslPart, "Parsing-Error expected part is NULL")
	}
	
	@Test
	def void featureExists() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		assertNotNull(instance.ejslPart.feature, "Parsing-Error expected feature is NULL")
	}
	
	@Test
	def void entitysExists() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		assertNotNull(instance.ejslPart.feature.entities, "Parsing-Error eJSL feature-Object is NULL")
		for (i : 0 ..< instance.ejslPart.feature.entities.size){
			assertNotNull(instance.ejslPart.feature.entities.get(i), "Parsing-Error expected entity is NULL")
		}
		
	}
	
	@Test
	def void referenceExists() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		assertNotNull(instance.ejslPart.feature.entities.get(1).references, "Parsing-Error expected reference is NULL")
		for (i : 0 ..< instance.ejslPart.feature.entities.get(1).references.size){
			assertNotNull(instance.ejslPart.feature.entities.get(1).references.get(i), "Parsing-Error expected entity is NULL")
		}
	}
	
	@Test
	def void createEntityReferences() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		val attributes = newArrayList()
		val references = newArrayList()
		val relations = newArrayList()
		val referencedEntity = newArrayList()
		
		//get values from instance
		for (i : 0 ..< instance.ejslPart.feature.entities.get(1).attributes.size){
			attributes.add(instance.ejslPart.feature.entities.get(1).attributes.get(i).name)
		}
		for (i : 0 ..< instance.ejslPart.feature.entities.get(1).references.size){
			references.add(
				"EntityAttribute = " +
				instance.ejslPart.feature.entities.get(1).references.get(i).attribute.get(0).name + " " +
				"*EntityReference = " +
				instance.ejslPart.feature.entities.get(1).references.get(i).entity.name + "." +
				instance.ejslPart.feature.entities.get(1).references.get(i).attributerefereced.get(0).name
			)
			referencedEntity.add(instance.ejslPart.feature.entities.get(1).references.get(i).entity)
			relations.add(instance.ejslPart.feature.entities.get(1).references.get(i).lower + " " +
				instance.ejslPart.feature.entities.get(1).references.get(i).upper)
		}
		
		val actualAttr = Joiner.on(", ").join(attributes)
		val actualRef = Joiner.on(", ").join(references)
		val actualRel = Joiner.on(", ").join(relations)
		
		//check object reference
		assertSame(referencedEntity.get(0), instance.ejslPart.feature.entities.get(2), "Failure: Reference to Entity failed")
		assertSame(referencedEntity.get(1), instance.ejslPart.feature.entities.get(4), "Failure: Reference to Entity failed")
		
		//check values
		assertEquals("name, price, desc, value, porder, supplier", actualAttr);
		assertEquals(
			"EntityAttribute = porder *EntityReference = Prodorder.ordNr, EntityAttribute = supplier *EntityReference = supplier.name",
			 actualRef
		);
		assertEquals("1 -1, 1 -1", actualRel);
	}
	
	@Test
	def void pagesExists() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		val expectedSize = 12
		
		//pages exist
		assertNotNull(instance.ejslPart.feature.pages, "Parsing-Error expected page is NULL")
		//amount of pages is correct
		assertEquals(instance.ejslPart.feature.pages.size, expectedSize)
	}
	
	@Test
	def void indexPageExists() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		assertNotNull(instance.ejslPart.feature.pages.get(0), "Parsing-Error expected index page is NULL")
	}
	
	@Test
	def void detailsPageExists() {
		
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//check page exists
		assertNotNull(instance.ejslPart.feature.pages.get(1), "Parsing-Error expected details page is NULL")
		//check type
		assertTrue((instance.ejslPart.feature.pages.get(1) as DynamicPage) as DetailsPage !== null)
	}
	
	@Test
	def void createIndexPage() {
			
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//check name and creation of multiple pages
		assertEquals("Customers", instance.ejslPart.feature.pages.get(0).name)
		assertEquals("Customer", instance.ejslPart.feature.pages.get(1).name)
		assertEquals("Products", instance.ejslPart.feature.pages.get(2).name)
		assertEquals("product", instance.ejslPart.feature.pages.get(3).name)
		
		//check referenced *Entities, filters and table columns are as expected
		val page = ((instance.ejslPart.feature.pages.get(0) as DynamicPage) as IndexPage)
		val entityReferenced = page.entities.get(0).name
		val tableCols = newArrayList()
		val filters = newArrayList()
		
		for (i : 0 ..< page.filters.size) {
			filters.add(page.filters.get(i).name)
		}
		for (i : 0 ..< page.tablecolumns.size) {
			tableCols.add(page.tablecolumns.get(i).name)
		}
		
		val actualFilters = Joiner.on(", ").join(filters)
		val actualTableCols = Joiner.on(", ").join(tableCols)
		
		assertEquals("lName", instance.ejslPart.feature.pages.get(0).links.get(0).linkedAttribute.name)
		assertEquals("customer", entityReferenced)
		assertEquals("sName, lName, adress", actualTableCols)
		assertEquals("lName, adress", actualFilters)
	}
	
	@Test
	def void createDetailsPage() {
			
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		val pageName = instance.ejslPart.feature.pages.get(1).name
		val linkedAttr = instance.ejslPart.feature.pages.get(1).links.get(0).linkedAttribute.name
		assertEquals("Customer", pageName);
		assertEquals("lName", linkedAttr);
	}
	
	@Test
	def void checkIndexLinkToDetails() {
			
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//get index and matching details page
		val pageIndex = ((instance.ejslPart.feature.pages.get(0) as DynamicPage) as IndexPage)
		val pageDetails = ((instance.ejslPart.feature.pages.get(1) as DynamicPage) as DetailsPage)
		
		//check values of index page
		val pageIndexLink = ((pageIndex.links.get(0) as Link) as InternalLink) as ContextLink
		assertEquals("Details", pageIndexLink.name)
		assertEquals("Customer", pageIndexLink.target.name)
		assertEquals("lName", pageIndexLink.linkedAttribute.name)
		assertEquals("lName", pageIndexLink.linkparameters.get(0).attvalue.name)
		
		//check reference
		assertSame(pageIndexLink.target, pageDetails, "Failure: Reference to DetailsPage failed")
		assertSame(((pageDetails.links.get(0) as Link) as InternalLink).target, pageIndex, "Failure: Reference to IndexPage failed")
		
		//check values of Details page
		val pageDetailsLink = ((pageDetails.links.get(0) as Link) as InternalLink)
		assertEquals("Customer", pageDetails.name)
		assertEquals("Customers", pageDetailsLink.target.name)
		assertEquals("customer", pageDetails.entities.get(0).name)
	}
	
	@Test
	def void extensionExists() {
				
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//get extension
		val ext = (instance.ejslPart as CMSExtension)
		assertNotNull(ext, "Parsing-Error expected extensions are Null ")
	}
	
	@Test
	def void componentExists() {
				
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//get extension
		val cmp = ((((instance.ejslPart as CMSExtension).extensions.get(0)) as Extension) as Component)
		assertNotNull(cmp, "Parsing-Error expected component is Null")
	}
	
	@Test
	def void manifestExists() {
				
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//get extension
		val cmp = (((instance.ejslPart as CMSExtension).extensions.get(0)) as Extension)
		assertNotNull(cmp.manifest, "Parsing-Error expected manifest is Null")
	}
	
	@Test
	def void languageExists() {
				
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//get extension
		val cmp = (((instance.ejslPart as CMSExtension).extensions.get(0)) as Extension)
		assertNotNull(cmp.languages, "Parsing-Error expected languages are Null")
	}
	
	@Test
	def void sectionsExists() {
				
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//get extension
		val cmp = (((instance.ejslPart as CMSExtension).extensions.get(0)) as Extension) as Component
		assertNotNull(cmp.sections, "Parsing-Error expected sections are Null")
	}
	
	@Test
	def void createExtensionComponent() {
				
		//parse the reference model
		val instance = parseHelper.parse(reference)
		
		//get extension
		val cmp = (((instance.ejslPart as CMSExtension).extensions.get(0)) as Extension) as Component
		
		//test component values
		assertEquals("ExampleShop", cmp.name)
		assertEquals("John Doe", cmp.manifest.authors.get(0).name)
		assertEquals("John.Doe@example.de", cmp.manifest.authors.get(0).authoremail)
		assertNotNull("Parsing-Error copyright should not be Null", cmp.manifest.copyright)
		assertNotNull("Parsing-Error license should not be Null", cmp.manifest.license)
		assertNotNull("Parsing-Error version should not be Null", cmp.manifest.version)
		assertEquals("de-DE", cmp.languages.get(0).name)
		assertEquals("en-GB", cmp.languages.get(1).name)
		assertEquals("Customer", (cmp.sections.get(0) as FrontendSection).pageRef.get(0).page.name)
		assertEquals("Products", (cmp.sections.get(0) as FrontendSection).pageRef.get(1).page.name)
		assertEquals("Customers", (cmp.sections.get(1) as BackendSection).pageRef.get(0).page.name)
		assertEquals("Customer", (cmp.sections.get(1) as BackendSection).pageRef.get(1).page.name)
		
	}
}
